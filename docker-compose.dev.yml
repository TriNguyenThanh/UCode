services:
  api-gateway:
    build:
      context: ./backend/src/api-gateway
      dockerfile: Dockerfile.dev
    container_name: api-gateway
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - JWT__KEY=YourSuperSecretKeyThatIsAtLeast32CharactersLong!
      - JWT__ISSUER=UserService
      - JWT__AUDIENCE=UserServiceClient
    volumes:
      - ./backend/src/api-gateway:/app
    depends_on:
      - user-service
      - assignment-service
    networks:
      - ucode_network
    restart: on-failure

  user-service:
    build:
      context: ./backend/src/user-service
      dockerfile: Dockerfile.dev
    container_name: user-service
    ports:
      - "5001:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=${USER_SERVICE_CONNECTION_STRING}
      - JWT__KEY=YourSuperSecretKeyThatIsAtLeast32CharactersLong!
      - JWT__ISSUER=UserService
      - JWT__AUDIENCE=UserServiceClient
    volumes:
      - ./backend/src/user-service:/app
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - ucode_network
    restart: on-failure
    command: 
      bash -c "dotnet ef database update -s Api/UserService.Api.csproj -p Infrastructure/UserService.Infrastructure.csproj && dotnet run --project Api/UserService.Api.csproj --urls http://0.0.0.0:5001"

  assignment-service:
    build:
      context: ./backend/src/assignment-service
      dockerfile: Dockerfile.dev
    container_name: assignment-service
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__AssignmentDb=${ASSIGNMENT_SERVICE_CONNECTION_STRING}
      - AssignmentDb=${ASSIGNMENT_SERVICE_CONNECTION_STRING}
      - UserService__BaseUrl=${USER_SERVICE_URL}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__Port=${RABBITMQ_PORT}
      - RabbitMQ__Username=${RABBITMQ_DEFAULT_USER}
      - RabbitMQ__Password=${RABBITMQ_DEFAULT_PASS}
    volumes:
      - ./backend/src/assignment-service:/app
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ucode_network
    restart: on-failure
    command: 
      bash -c "dotnet ef database update -s Api/Api.csproj -p Infrastructure/Infrastructure.csproj && dotnet run --project Api/Api.csproj --urls http://0.0.0.0:5002"

  judge-service:
    build:
      context: ./backend/src/judge-service
      dockerfile: Dockerfile.dev
    container_name: judge-service
    privileged: true
    cap_add:
      - SYS_ADMIN
    environment:
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASS=${RABBITMQ_DEFAULT_PASS}
      - MAX_CONCURRENT_SUBMISSIONS=${MAX_CONCURRENT_SUBMISSIONS}
      - MAX_WORKERS_PER_SUBMISSION=${MAX_WORKERS_PER_SUBMISSION}
      - MEMORY_THRESHOLD=${MEMORY_THRESHOLD}
      - CPU_THRESHOLD=${CPU_THRESHOLD}
    tty: true
    stdin_open: true
    volumes:
      - ./backend/src/judge-service:/app
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - ucode_network
    restart: on-failure

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "${RABBITMQ_PORT_EXTERNAL}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT}:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - ucode_network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    ports:
      - "${SQLSERVER_EXTERNAL_PORT}:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD}
      - MSSQL_PID=Developer
      - MSSQL_AGENT_ENABLED=true
    volumes:
      - sqlserver-data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$$MSSQL_SA_PASSWORD\" -Q \"SELECT 1\" -C -b || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - ucode_network
    restart: unless-stopped
  
  file-service:
    build:
      context: ./backend/src/file-service
      dockerfile: Dockerfile.dev
    container_name: file-service
    ports:
      - "5073:5073"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - AWS__Region=${AWS_REGION}
      - AWS__BucketName=${AWS_S3_BUCKET_NAME}
      - AWS__AccessKey=${AWS_ACCESS_KEY_ID}
      - AWS__SecretKey=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ./backend/src/file-service:/app
    networks:
      - ucode_network
    restart: on-failure
    command: dotnet watch run --project file-service.csproj --urls http://0.0.0.0:5073

volumes:
  redis-data:
  sqlserver-data:

networks:
  ucode_network:
    driver: bridge