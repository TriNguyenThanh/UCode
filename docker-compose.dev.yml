services:
  api-gateway:
    build:
      context: ./backend/src/api-gateway
      dockerfile: Dockerfile.dev
    container_name: api-gateway
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - JWT__KEY=YourSuperSecretKeyThatIsAtLeast32CharactersLong!
      - JWT__ISSUER=UserService
      - JWT__AUDIENCE=UserServiceClient
    volumes:
      - ./backend/src/api-gateway:/app
    depends_on:
      - user-service
      - assignment-service
    restart: on-failure

  user-service:
    build:
      context: ./backend/src/user-service
      dockerfile: Dockerfile.dev
    container_name: user-service
    ports:
      - "5001:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=${USER_SERVICE_CONNECTION_STRING}
      - JWT__KEY=YourSuperSecretKeyThatIsAtLeast32CharactersLong!
      - JWT__ISSUER=UserService
      - JWT__AUDIENCE=UserServiceClient
    volumes:
      - ./backend/src/user-service:/app
    depends_on:
      sqlserver:
        condition: service_healthy
    restart: on-failure
    command: 
      bash -c "dotnet ef database update -s Api/UserService.Api.csproj -p Infrastructure/UserService.Infrastructure.csproj && dotnet run --project Api/UserService.Api.csproj --urls http://0.0.0.0:5001"

  assignment-service:
    build:
      context: ./backend/src/assignment-service
      dockerfile: Dockerfile.dev
    container_name: assignment-service
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__AssignmentDb=${ASSIGNMENT_SERVICE_CONNECTION_STRING}
      - AssignmentDb=${ASSIGNMENT_SERVICE_CONNECTION_STRING}
      - UserService__BaseUrl=${USER_SERVICE_URL}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__Port=${RABBITMQ_PORT}
      - RabbitMQ__Username=${RABBITMQ_DEFAULT_USER}
      - RabbitMQ__Password=${RABBITMQ_DEFAULT_PASS}
    volumes:
      - ./backend/src/assignment-service:/app
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: on-failure
    command: 
      bash -c "dotnet ef database update -s Api/Api.csproj -p Infrastructure/Infrastructure.csproj && dotnet run --project Api/Api.csproj --urls http://0.0.0.0:5002"

  judge-service:
    build:
      context: ./backend/src/judge-service
      dockerfile: Dockerfile.dev
    container_name: judge-service
    privileged: true  # Cần thiết để sử dụng isolate với các tính năng đầy đủ
    cap_add:
      - SYS_ADMIN
    environment:
      # === RabbitMQ Connection ===
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASS=${RABBITMQ_DEFAULT_PASS}
      
      # === Adaptive Consumer Config ===
      - MAX_CONCURRENT_SUBMISSIONS=${MAX_CONCURRENT_SUBMISSIONS}
      - MAX_WORKERS_PER_SUBMISSION=${MAX_WORKERS_PER_SUBMISSION}
      
      # === Health Check Thresholds ===
      - MEMORY_THRESHOLD=${MEMORY_THRESHOLD}
      - CPU_THRESHOLD=${CPU_THRESHOLD}
    
    tty: true
    stdin_open: true
    volumes:
      - ./backend/src/judge-service:/app
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: on-failure

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "${RABBITMQ_PORT_EXTERNAL}:5672"     # RabbitMQ message broker
      - "${RABBITMQ_MANAGEMENT_PORT}:15672"   # Web UI
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest # (khuyến nghị: ghim tag CU cụ thể)
    container_name: sqlserver
    ports:
      - "${SQLSERVER_EXTERNAL_PORT}:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD}   # dùng MSSQL_SA_PASSWORD thay cho SA_PASSWORD
      # - MSSQL_PID=Developer               # bật dòng này nếu là môi trường dev/test
      # - MSSQL_AGENT_ENABLED=true          # tùy chọn: bật SQL Agent nếu cần
    healthcheck:
      test: /bin/bash -c "</dev/tcp/localhost/1433" || exit 1
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
  
  file-service:
    build:
      context: ./backend/src/file-service
      dockerfile: Dockerfile.dev
    container_name: file-service
    ports:
      - "5073:5073"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - AWS__Region=${AWS_REGION}
      - AWS__BucketName=${AWS_S3_BUCKET_NAME}
      - AWS__AccessKey=${AWS_ACCESS_KEY_ID}
      - AWS__SecretKey=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ./backend/src/file-service:/app
    restart: on-failure
    command: dotnet watch run --project file-service.csproj --urls http://0.0.0.0:5073

  # redis:
  #   image: redis:latest
  #   container_name: redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data

volumes:
  redis-data: