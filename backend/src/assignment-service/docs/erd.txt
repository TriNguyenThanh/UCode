---
config:
  layout: elk
---
erDiagram
    %% ================================
    %% 1️⃣ ASSIGNMENT & STUDENT FLOW
    %% ================================
    Assignment ||--o{ AssignmentProblem : "contains"
    Assignment ||--o{ AssignmentUser : "assigned_to"
    Problem ||--o{ AssignmentProblem : "included_in"


    %% ================================
    %% 2️⃣ CHẤM CODE & TESTCASE
    %% ================================
    Problem ||--o{ Dataset : "has_dataset"
    Dataset ||--o{ TestCaseFile : "stored_in_file"
    %% ================================
    %% 3️⃣ BEST SUBMISSION & SUBMISSIONS
    %% ================================
    AssignmentUser ||--o{ Submission : "has_submissions"
    Problem ||--o{ Submission : "submitted_for"
    Dataset ||--o{ Submission : "tested_against"
    Submission ||--o{ BestSubmission : "can_be_best"

    %% ================================
    %% 4️⃣ PROBLEM META
    %% ================================
    Problem ||--o{ ProblemAsset : "has_asset"
    Problem ||--o{ ProblemLanguage : "has_language_override"
    Language ||--o{ ProblemLanguage : "overridden_in"
    Problem ||--o{ ProblemTag : "tagged"
    Tag ||--o{ ProblemTag : "used_in"

    %% ================================
    %% ENTITY DEFINITIONS
    %% ================================
    Assignment {
        UUID id PK
        nvarchar_50_ assignment_type
        nvarchar_200_ title
        nvarchar_2000_ description
        datetime2 start_time
        datetime2 end_time
        int total_points
        bit allow_late_submission
        nvarchar_50_ status
        UUID class_id FK
        UUID assigned_by FK
        datetime2 created_at
        datetime2 assigned_at
    }

    AssignmentUser {
        UUID id PK
        UUID assignment_id FK
        UUID user_id FK
        nvarchar_50_ status
        datetime2 assigned_at
        datetime2 started_at
        int tab_switch_count "Default 0"
        int captured_ai_count "Default 0"
        int score
        int max_score
    }

    AssignmentProblem {
        UUID assignment_id PK, FK
        UUID problem_id PK, FK
        int points
        int order_index
    }

    Problem {
        UUID id PK
        nvarchar50 code
        nvarchar255 slug
        nvarchar500 title
        nvarchar16 difficulty
        nvarchar16 visibility
        nvarchar16 status
        nvarchar1000 statement_md_ref
        nvarchar50 input_format
        nvarchar50 output_format
        nvarchar50 constraints
        nvarchar1000 description
        nvarchar1000 solution
        int max_score
        int time_limit_ms
        int memory_limit_kb
        int source_limit_kb
        int stack_limit_kb
        bit is_locked
        datetime2 created_at
        datetime2 updated_at
        UUID owner_id FK
    }

    ProblemTag {
        UUID problem_id PK, FK
        UUID tag_id PK, FK
    }

    Tag {
        UUID id PK
        nvarchar_64_ name
        nvarchar_16_ category
    }

    ProblemAsset {
        UUID id PK
        UUID problem_id FK
        nvarchar_16_ type "IMAGE, VIDEO, PDF, STATEMENT, SOLUTION, TUTORIAL, HINT"
        nvarchar_1000_ object_ref "S3/Blob URL or markdown content"
        nvarchar_100_ checksum
        nvarchar_255_ title "Optional: tên hiển thị"
        nvarchar_16_ format "MARKDOWN, HTML, URL, TEXT"
        int order_index "Thứ tự hiển thị"
        datetime2 created_at
    }

    Dataset {
        UUID id PK
        UUID problem_id FK
        nvarchar_100_ name
        nvarchar_16_ kind
    }

    TestCaseFile {
        UUID id PK
        UUID dataset_id FK
        nvarchar_500_ input_ref
        nvarchar_500_ output_ref
        nvarchar_100_ score
    }

    Language {
        UUID id PK
        nvarchar_50_ code "cpp, java, python, javascript, csharp, rust, go..."
        nvarchar_100_ display_name "C++17, Java 17, Python 3..."
        decimal_5_2_ default_time_factor "Multiplier for time limit (Python=2.5, C++=1.0)"
        int default_memory_kb "Default memory override (NULL = use problem default)"
        nvarchar_max_ default_head "Default code template - imports/setup"
        nvarchar_max_ default_body "Default code template - main function"
        nvarchar_max_ default_tail "Default code template - test runner"
        bit is_enabled "Admin can disable languages"
        int display_order "Display order in UI"
        datetime2 created_at
    }

    ProblemLanguage {
        UUID problem_id PK, FK "Composite PK with language_id"
        UUID language_id PK, FK "Composite PK with problem_id"
        decimal_5_2_ time_factor_override "NULL = use Language.default_time_factor"
        int memory_kb_override "NULL = use Language.default_memory_kb"
        nvarchar_max_ head_override "NULL = use Language.default_head"
        nvarchar_max_ body_override "NULL = use Language.default_body"
        nvarchar_max_ tail_override "NULL = use Language.default_tail"
        bit is_allowed "Teacher can disable specific language for this problem"
        datetime2 created_at
    }

    Submission {
        UUID id PK
        UUID assignment_id FK
        UUID user_id FK
        UUID problem_id FK
        UUID dataset_id FK
        nvarchar_50_ source_code_ref
        nvarchar_50_ language
        nvarchar_255 compare_result
        nvarchar_50_ status
        nvarchar_255_ error_code
        nvarchar_1000_ error_message
        int total_testcase
        int passed_testcase
        int score
        bigint total_time
        bigint total_memory
        datetime2 submitted_at
    }

   