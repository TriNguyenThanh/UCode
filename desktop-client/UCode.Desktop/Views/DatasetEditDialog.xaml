<mah:MetroWindow x:Class="UCode.Desktop.Views.DatasetEditDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:local="clr-namespace:UCode.Desktop.Views"
        Title="Quáº£n lÃ½ Dataset" 
        Height="700" Width="1100"
        WindowStartupLocation="CenterOwner"
        Background="#F5F5F5"
        ResizeMode="NoResize"
        ShowMinButton="False"
        ShowMaxRestoreButton="False"
        TextOptions.TextFormattingMode="Display"
        TextOptions.TextRenderingMode="ClearType"
        RenderOptions.BitmapScalingMode="HighQuality">

    <Grid>
        <!-- Loading Overlay -->
        <Grid Background="#80000000" 
              Visibility="{Binding IsSaving, Converter={StaticResource BooleanToVisibilityConverter}}" 
              Panel.ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4" Foreground="#FACB01"/>
                <TextBlock Text="Äang lÆ°u..." Foreground="White" FontSize="16" FontWeight="SemiBold" Margin="0,15,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Main Content -->
        <Grid Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,20">
                <TextBlock FontSize="24" FontWeight="Bold" Foreground="#191970">
                    <TextBlock.Text>
                        <Binding Path="IsEditing">
                            <Binding.Converter>
                                <local:BoolToTextConverter TrueText="Chá»‰nh sá»­a Dataset" FalseText="ThÃªm Dataset má»›i"/>
                            </Binding.Converter>
                        </Binding>
                    </TextBlock.Text>
                </TextBlock>
            </StackPanel>

            <!-- Dataset Info -->
            <Border Grid.Row="1" Style="{StaticResource CardStyle}" Padding="20" Margin="0,0,0,20">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="15"/>
                        <ColumnDefinition Width="1*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="TÃªn Dataset *" FontSize="14" FontWeight="SemiBold" Foreground="#191970" Margin="0,0,0,8"/>
                        <TextBox Text="{Binding DatasetName, UpdateSourceTrigger=PropertyChanged}"
                                 mah:TextBoxHelper.Watermark="VD: Sample Test Cases, Edge Cases..."
                                 Height="40" FontSize="14" Padding="10"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Loáº¡i Dataset *" FontSize="14" FontWeight="SemiBold" Foreground="#191970" Margin="0,0,0,8"/>
                        <ComboBox SelectedItem="{Binding DatasetKind, Mode=TwoWay}"
                                  ItemsSource="{Binding DatasetKindOptions}"
                                  Height="40" FontSize="14"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Test Cases Section -->
            <Border Grid.Row="2" Style="{StaticResource CardStyle}" Padding="20">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Test Cases Header -->
                    <Grid Grid.Row="0" Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <TextBlock FontSize="16" FontWeight="SemiBold" Foreground="#191970" VerticalAlignment="Center">
                                <Run Text="Test Cases ("/>
                                <Run Text="{Binding TestCases.Count, Mode=OneWay}"/>
                                <Run Text=")"/>
                            </TextBlock>
                            <Border Background="#0071E3" CornerRadius="12" Padding="8,4" Margin="15,0,0,0"
                                    Visibility="{Binding HasSelectedTestCases, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Foreground="White" FontWeight="SemiBold" FontSize="11">
                                    <Run Text="{Binding SelectedTestCases.Count, Mode=OneWay}"/>
                                    <Run Text=" Ä‘Ã£ chá»n"/>
                                </TextBlock>
                            </Border>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <!-- Delete Selected Button -->
                            <Button Content="ðŸ—‘ XÃ³a Ä‘Ã£ chá»n" 
                                    Foreground="#FF3B30"
                                    Background="Transparent"
                                    BorderBrush="#FF3B30"
                                    BorderThickness="1"
                                    Padding="10,5"
                                    Margin="0,0,10,0"
                                    Cursor="Hand"
                                    Command="{Binding DeleteSelectedTestCasesCommand}"
                                    Visibility="{Binding HasSelectedTestCases, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                            CornerRadius="4"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#FFEBE9"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- Download Template Button -->
                            <Button Content="â¬‡ Template" 
                                    Foreground="#0071E3"
                                    Background="Transparent"
                                    BorderBrush="#0071E3"
                                    BorderThickness="1"
                                    Padding="10,5"
                                    Margin="0,0,10,0"
                                    Cursor="Hand"
                                    Command="{Binding DownloadTemplateCommand}">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                            CornerRadius="4"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#E3F2FD"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- Import Excel Button -->
                            <Button Content="ðŸ“ Nháº­p Excel" 
                                    Foreground="#34C759"
                                    Background="Transparent"
                                    BorderBrush="#34C759"
                                    BorderThickness="1"
                                    Padding="10,5"
                                    Margin="0,0,10,0"
                                    Cursor="Hand"
                                    Command="{Binding ImportExcelCommand}">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                            CornerRadius="4"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#E8F5E9"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- Add Test Case Button -->
                            <Button Content="+ ThÃªm Test Case" 
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Command="{Binding AddTestCaseCommand}"
                                    Padding="12,6"/>
                        </StackPanel>
                    </Grid>

                    <!-- Test Cases Table -->
                    <Grid Grid.Row="1">
                        <!-- Empty State -->
                        <Border Background="#E3F2FD" BorderBrush="#2196F3" BorderThickness="1" 
                                CornerRadius="4" Padding="20" 
                                Visibility="{Binding HasNoTestCases, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="â„¹" Foreground="#2196F3" FontSize="20" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Text="ChÆ°a cÃ³ test case nÃ o. Nháº¥n 'ThÃªm Test Case' Ä‘á»ƒ báº¯t Ä‘áº§u." 
                                           Foreground="#1976D2" FontSize="14" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- DataGrid -->
                        <DataGrid ItemsSource="{Binding TestCases}"
                                  Style="{StaticResource ModernDataGrid}"
                                  RowStyle="{StaticResource ModernDataGridRow}"
                                  CellStyle="{StaticResource ModernDataGridCell}"
                                  ColumnHeaderStyle="{StaticResource ModernDataGridColumnHeader}"
                                  Visibility="{Binding HasTestCases, Converter={StaticResource BooleanToVisibilityConverter}}">
                            
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Width="50" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                    <DataGridCheckBoxColumn.Header>
                                        <CheckBox IsChecked="{Binding DataContext.AllTestCasesSelected, RelativeSource={RelativeSource AncestorType=Window}, Mode=TwoWay}"
                                                  Style="{StaticResource SelectionCheckBox}"/>
                                    </DataGridCheckBoxColumn.Header>
                                    <DataGridCheckBoxColumn.ElementStyle>
                                        <Style TargetType="CheckBox" BasedOn="{StaticResource SelectionCheckBox}"/>
                                    </DataGridCheckBoxColumn.ElementStyle>
                                </DataGridCheckBoxColumn>
                                <DataGridTextColumn Header="â˜°" Width="40" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="TextAlignment" Value="Center"/>
                                            <Setter Property="Cursor" Value="Hand"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTemplateColumn Header="#" Width="60">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Background="#0071E3" CornerRadius="12" Padding="8,4" HorizontalAlignment="Center">
                                                <TextBlock Text="{Binding IndexNo, StringFormat='#{0}'}" Foreground="White" FontWeight="SemiBold" FontSize="11"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="Input Preview" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding InputPreview}" 
                                                       FontFamily="Consolas" 
                                                       FontSize="11" 
                                                       Foreground="#1D1D1F"
                                                       Background="#F5F5F7"
                                                       Padding="8"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxHeight="60"
                                                       TextWrapping="Wrap"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="Output Preview" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding OutputPreview}" 
                                                       FontFamily="Consolas" 
                                                       FontSize="11" 
                                                       Foreground="#1D1D1F"
                                                       Background="#F5F5F7"
                                                       Padding="8"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxHeight="60"
                                                       TextWrapping="Wrap"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="Thao tÃ¡c" Width="120">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Button Content="âœ" 
                                                        Foreground="#007bff"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Padding="5"
                                                        Cursor="Hand"
                                                        Command="{Binding DataContext.EditTestCaseCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                                                            <ContentPresenter/>
                                                                        </Border>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Style.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                                    <Setter Property="FontSize" Value="16"/>
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                                <Button Content="ðŸ—‘" 
                                                        Foreground="#FF3B30"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Padding="5"
                                                        Cursor="Hand"
                                                        Command="{Binding DataContext.DeleteTestCaseCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                                                            <ContentPresenter/>
                                                                        </Border>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Style.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                                    <Setter Property="FontSize" Value="16"/>
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Grid>
            </Border>

            <!-- Actions -->
            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                <Button Content="Há»§y" Style="{StaticResource SecondaryButtonStyle}"
                        Click="Cancel_Click"
                        Width="120" Margin="0,0,15,0"/>
                <Button Content="{Binding SaveButtonText}" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        Command="{Binding SaveDatasetCommand}"
                        IsEnabled="{Binding !IsSaving}"
                        Width="150"/>
            </StackPanel>
        </Grid>
    </Grid>
</mah:MetroWindow>

