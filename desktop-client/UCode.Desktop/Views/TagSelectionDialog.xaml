<mah:MetroWindow x:Class="UCode.Desktop.Views.TagSelectionDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        Title="Quản lý Tags" 
        Height="600" Width="800"
        WindowStartupLocation="CenterOwner"
        Background="#F5F5F5"
        ResizeMode="NoResize"
        ShowMinButton="False"
        ShowMaxRestoreButton="False"
        TextOptions.TextFormattingMode="Display"
        TextOptions.TextRenderingMode="ClearType"
        RenderOptions.BitmapScalingMode="HighQuality">

    <Grid>
        <!-- Loading Overlay -->
        <Grid Background="#80000000" 
              Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" 
              Panel.ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4" Foreground="#FACB01"/>
                <TextBlock Text="Đang tải..." Foreground="White" FontSize="16" FontWeight="SemiBold" Margin="0,15,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Main Content -->
        <Grid Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,20">
                <TextBlock Text="Quản lý Tags" FontSize="24" FontWeight="Bold" Foreground="#191970"/>
                <TextBlock Text="Chọn các tag phù hợp cho bài toán này" FontSize="14" Foreground="#666" Margin="0,5,0,0"/>
            </StackPanel>

            <!-- Selected Tags -->
            <Border Grid.Row="1" Style="{StaticResource CardStyle}" Padding="15" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock FontSize="14" FontWeight="SemiBold" Foreground="#191970" Margin="0,0,0,10">
                        <Run Text="Tags đã chọn ("/>
                        <Run Text="{Binding SelectedTagIds.Count, Mode=OneWay}"/>
                        <Run Text=")"/>
                    </TextBlock>

                    <!-- Selected Tags Display -->
                    <ScrollViewer MaxHeight="100" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding SelectedTags}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#34C759" CornerRadius="12" Padding="10,5" Margin="0,0,5,5">
                                        <TextBlock Text="{Binding Name}" Foreground="White" FontWeight="SemiBold"/>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <TextBlock Text="Chưa có tag nào được chọn" 
                               FontSize="13" Foreground="#999" 
                               Visibility="{Binding HasNoSelectedTags, Converter={StaticResource BooleanToVisibilityConverter}}"
                               Margin="0,10,0,0"/>
                </StackPanel>
            </Border>

            <!-- All Tags -->
            <Border Grid.Row="2" Style="{StaticResource CardStyle}" Padding="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" FontSize="14" FontWeight="SemiBold" Foreground="#191970" Margin="0,0,0,10">
                        <Run Text="Tất cả các tags ("/>
                        <Run Text="{Binding AllTags.Count, Mode=OneWay}"/>
                        <Run Text=")"/>
                    </TextBlock>

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding AllTags}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border CornerRadius="12" Padding="10,5" Margin="0,0,5,5" Cursor="Hand"
                                            MouseLeftButtonDown="Tag_MouseLeftButtonDown"
                                            Tag="{Binding}">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="#F5F5F7"/>
                                                <Setter Property="BorderThickness" Value="1"/>
                                                <Setter Property="BorderBrush" Value="#D2D2D7"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                        <Setter Property="Background" Value="#FACB01"/>
                                                        <Setter Property="BorderBrush" Value="#FACB01"/>
                                                    </DataTrigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#E8E8ED"/>
                                                    </Trigger>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding IsSelected}" Value="True"/>
                                                            <Condition Binding="{Binding IsMouseOver, RelativeSource={RelativeSource Self}}" Value="True"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Background" Value="#0051D5"/>
                                                        <Setter Property="BorderBrush" Value="#0051D5"/>
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="#1D1D1F"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                            <Setter Property="Foreground" Value="White"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Actions -->
            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                <Button Content="Hủy" Style="{StaticResource SecondaryButtonStyle}"
                        Click="Cancel_Click"
                        Width="120" Margin="0,0,15,0"/>
                <Button Content="Lưu" Style="{StaticResource PrimaryButtonStyle}"
                        Command="{Binding SaveCommand}"
                        IsEnabled="{Binding IsSaving, Converter={StaticResource InverseBooleanConverter}}"
                        Width="120"/>
            </StackPanel>
        </Grid>
    </Grid>
</mah:MetroWindow>

